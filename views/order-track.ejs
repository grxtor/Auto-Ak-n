<%- include('partials/header') %>
    <div class="page-header">
        <div class="breadcrumb"><a href="/">Ana Sayfa</a> <span>→</span> <span>Sipariş Takip</span></div>
        <h1>Sipariş Takip</h1>
    </div>
    <section class="section" style="max-width:600px;margin:0 auto;">
        <div class="panel-card">
            <p class="muted" style="margin-bottom:16px;">Sipariş numaranızı girerek durumunu sorgulayabilirsiniz.</p>
            <form onsubmit="trackOrder(event)" style="display:flex;gap:8px;">
                <input type="text" id="orderNoInput" placeholder="SA-XXXXX" required
                    style="flex:1;padding:10px 14px;border:1px solid var(--gray-200);border-radius:10px;font-family:inherit;" />
                <button class="btn" type="submit">Sorgula</button>
            </form>
        </div>
        <div id="orderResult" style="margin-top:20px;display:none;">
            <div class="panel-card">
                <h3 id="rOrderNo" style="font-family:'Anton',sans-serif;font-size:20px;margin-bottom:16px;"></h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                    <div><strong style="font-size:12px;color:var(--gray-500);">Durum</strong>
                        <div id="rStatus"></div>
                    </div>
                    <div><strong style="font-size:12px;color:var(--gray-500);">Ödeme</strong>
                        <div id="rPayment"></div>
                    </div>
                    <div><strong style="font-size:12px;color:var(--gray-500);">Toplam</strong>
                        <div id="rTotal" style="font-weight:700;color:var(--red);"></div>
                    </div>
                    <div><strong style="font-size:12px;color:var(--gray-500);">Tarih</strong>
                        <div id="rDate"></div>
                    </div>
                </div>
                <div id="rTracking"
                    style="display:none;margin-bottom:12px;padding:12px;background:var(--green-bg);border-radius:10px;">
                    <strong>Kargo:</strong> <span id="rCargo"></span> — <span id="rTrackNo"></span></div>
                <div style="margin-top:12px;"><strong style="font-size:13px;">Ürünler:</strong>
                    <div id="rItems"></div>
                </div>
            </div>
        </div>
    </section>
    <script>
        const statusMap = { pending: 'Beklemede', confirmed: 'Onaylandı', preparing: 'Hazırlanıyor', shipped: 'Kargoda', delivered: 'Teslim Edildi', cancelled: 'İptal' };
        const payMap = { waiting: 'Bekleniyor', uploaded: 'Dekont Yüklendi', approved: 'Onaylandı', rejected: 'Reddedildi' };
        async function trackOrder(e) {
            e.preventDefault();
            const no = document.getElementById('orderNoInput').value.trim();
            const r = await fetch('/api/orders/track/' + no); const d = await r.json();
            if (d.error) { showToast(d.error); document.getElementById('orderResult').style.display = 'none'; return; }
            document.getElementById('orderResult').style.display = 'block';
            document.getElementById('rOrderNo').textContent = 'Sipariş: ' + d.order_no;
            document.getElementById('rStatus').innerHTML = `<span class="status ${d.status === 'delivered' ? 'success' : d.status === 'cancelled' ? 'pending' : 'warn'}">${statusMap[d.status] || d.status}</span>`;
            document.getElementById('rPayment').innerHTML = `<span class="status ${d.payment_status === 'approved' ? 'success' : 'warn'}">${payMap[d.payment_status] || d.payment_status}</span>`;
            document.getElementById('rTotal').textContent = Number(d.total).toLocaleString('tr-TR') + ' TL';
            document.getElementById('rDate').textContent = new Date(d.created_at).toLocaleDateString('tr-TR');
            if (d.tracking_no) { document.getElementById('rTracking').style.display = 'block'; document.getElementById('rCargo').textContent = d.cargo_company || ''; document.getElementById('rTrackNo').textContent = d.tracking_no; }
            else document.getElementById('rTracking').style.display = 'none';
            document.getElementById('rItems').innerHTML = d.items.map(i => `<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid var(--gray-100);"><span>${i.product_name} × ${i.quantity}</span><span style="font-weight:700;">${Number(i.price * i.quantity).toLocaleString('tr-TR')} TL</span></div>`).join('');
        }
        document.addEventListener('DOMContentLoaded', () => { const p = new URLSearchParams(location.search); if (p.get('no')) { document.getElementById('orderNoInput').value = p.get('no'); document.getElementById('orderNoInput').form.dispatchEvent(new Event('submit')); } });
    </script>
    <%- include('partials/footer') %>