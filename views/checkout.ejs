<%- include('partials/header') %>
    <div class="page-header">
        <div class="breadcrumb"><a href="/">Ana Sayfa</a> <span>â†’</span> <a href="/sepet">Sepet</a> <span>â†’</span>
            <span>Ã–deme</span></div>
        <h1>SipariÅŸi Tamamla</h1>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:24px;">
        <div class="panel-card">
            <div class="card-header">Ä°letiÅŸim ve Adres Bilgileri</div>
            <form id="checkoutForm" onsubmit="placeOrder(event)">
                <div class="form-row">
                    <div class="form-group"><label>Ad Soyad *</label><input type="text" id="cName" required
                            value="<%= user ? user.name : '' %>" /></div>
                    <div class="form-group"><label>Telefon *</label><input type="tel" id="cPhone" required
                            placeholder="05XX XXX XXXX" /></div>
                </div>
                <div class="form-group"><label>E-posta</label><input type="email" id="cEmail"
                        value="<%= user ? user.email : '' %>" /></div>
                <div class="form-group"><label>Adres *</label><textarea id="cAddress" rows="3" required
                        placeholder="Teslimat adresi..."></textarea></div>
                <div class="form-group"><label>SipariÅŸ Notu</label><textarea id="cNote" rows="2"
                        placeholder="Ä°steÄŸe baÄŸlÄ±"></textarea></div>

                <div style="margin-top:24px;">
                    <div class="card-header">IBAN ile Ã–deme</div>
                    <div class="iban-box" style="margin:12px 0;">
                        <div class="iban-title">
                            <%= settings.iban_holder || '' %>
                        </div>
                        <div class="iban" style="user-select:all;">
                            <%= settings.iban || '' %>
                        </div>
                        <div class="iban-note">
                            <%= settings.iban_note || '' %>
                        </div>
                    </div>
                    <p class="muted" style="font-size:12px;margin-bottom:16px;">Havale sonrasÄ± dekont yÃ¼kleyebilirsiniz.
                    </p>
                    <div class="img-upload-area" onclick="document.getElementById('receiptFile').click()">
                        <input type="file" id="receiptFile" accept="image/*" onchange="previewReceipt(this)" />
                        <div class="upload-icon">ðŸ“„</div>
                        <div class="upload-text">Dekont YÃ¼kle (Opsiyonel)</div>
                        <div class="upload-hint">JPG, PNG â€” Max 5MB</div>
                    </div>
                    <img id="receiptPreview" class="img-preview" style="display:none;" />
                </div>
                <button class="btn btn-lg btn-block" type="submit" style="margin-top:24px;">âœ… SipariÅŸi Tamamla</button>
            </form>
        </div>
        <div>
            <div class="panel-card" style="position:sticky;top:80px;">
                <div class="card-header">SipariÅŸ Ã–zeti</div>
                <div id="orderSummary"></div>
                <hr style="border:none;border-top:1px solid var(--gray-200);margin:12px 0;" />
                <div style="display:flex;justify-content:space-between;font-weight:800;font-size:18px;">
                    <span>Toplam</span><span id="orderTotal" style="color:var(--red);">0 TL</span></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="successModal">
        <div class="modal" style="text-align:center;">
            <div style="font-size:64px;margin-bottom:16px;">ðŸŽ‰</div>
            <h2>SipariÅŸiniz AlÄ±ndÄ±!</h2>
            <p class="muted">SipariÅŸ numaranÄ±z:</p>
            <div id="orderNo" style="font-family:'Anton',sans-serif;font-size:28px;color:var(--red);margin:12px 0;">
            </div>
            <a class="btn btn-lg" href="/siparis-takip" id="trackLink">SipariÅŸ Takip â†’</a>
            <a class="btn btn-outline" href="/" style="margin-top:8px;display:block;">Ana Sayfaya DÃ¶n</a>
        </div>
    </div>

    <script>
        async function renderSummary() {
            const items = getCart(); const el = document.getElementById('orderSummary');
            if (!items.length) { el.innerHTML = '<p class="muted">Sepet boÅŸ</p>'; return; }
            let html = '', total = 0;
            for (const item of items) {
                const r = await fetch('/api/products/' + item.id); const p = await r.json(); if (p.error) continue;
                const lt = p.price * item.qty; total += lt;
                html += `<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:13px;"><span>${p.name} Ã— ${item.qty}</span><span style="font-weight:700;">${lt.toLocaleString('tr-TR')} TL</span></div>`;
            }
            el.innerHTML = html; document.getElementById('orderTotal').textContent = total.toLocaleString('tr-TR') + ' TL';
        }
        function previewReceipt(input) { if (input.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById('receiptPreview').src = e.target.result; document.getElementById('receiptPreview').style.display = 'block'; }; r.readAsDataURL(input.files[0]); } }
        async function placeOrder(e) {
            e.preventDefault(); const items = getCart(); if (!items.length) { showToast('Sepet boÅŸ!'); return; }
            const data = { name: document.getElementById('cName').value.trim(), phone: document.getElementById('cPhone').value.trim(), email: document.getElementById('cEmail').value.trim(), address: document.getElementById('cAddress').value.trim(), note: document.getElementById('cNote').value.trim(), items: items.map(i => ({ id: i.id, qty: i.qty })) };
            const r = await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            const d = await r.json(); if (d.error) { showToast(d.error); return; }
            const f = document.getElementById('receiptFile').files[0];
            if (f) { const fd = new FormData(); fd.append('order_no', d.order_no); fd.append('receipt', f); await fetch('/api/orders/upload-receipt', { method: 'POST', body: fd }); }
            localStorage.removeItem('autoakin_cart'); updateCartBadge();
            document.getElementById('orderNo').textContent = d.order_no;
            document.getElementById('trackLink').href = '/siparis-takip?no=' + d.order_no;
            document.getElementById('successModal').classList.add('open');
        }
        document.addEventListener('DOMContentLoaded', renderSummary);
    </script>
    <%- include('partials/footer') %>