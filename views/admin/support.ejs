<%- include('layout') %>

    <h2 style="margin-bottom:24px;">Canlı Destek (<%= sessions.length %> sohbet)</h2>

    <div class="chat-container">
        <div class="chat-list">
            <% sessions.forEach(s=> { %>
                <div class="chat-item <%= s.status==='active'?'':'closed' %>" data-id="<%= s.id %>" id="ci_<%= s.id %>">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <strong style="font-size:14px;color:#1e293b;">
                            <%= s.visitor_name %>
                        </strong>
                        <span class="status <%= s.status==='active'?'success':'pending' %>"
                            style="font-size:9px;padding:4px 8px;">
                            <%= s.status==='active' ?'Aktif':'Kapalı' %>
                        </span>
                    </div>
                    <div
                        style="font-size:12px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px;">
                        <%= s.last_message || 'Henüz mesaj yok' %>
                    </div>
                    <div class="chat-list" id="chatList">
                        <!-- Sessions will be loaded here -->
                    </div>
                    <div class="chat-main">
                        <div class="card-header" id="chatTitle">Lütfen bir konuşma seçin</div>
                        <div class="chat-messages" id="chatMessages">
                            <!-- Messages will be loaded here -->
                        </div>
                        <div class="chat-input-area"
                            style="padding: 20px; border-top: 1px solid var(--border-light); display: flex; gap: 12px;">
                            <input type="text" id="msgInput" placeholder="Mesajınızı yazın..." style="flex: 1;" />
                            <button class="btn" onclick="sendMessage()">Gönder</button>
                        </div>
                    </div>
                </div>

                <script>
                    document.addEventListener('click', (e) => {
                        const chatItem = e.target.closest('.chat-item');
                        if (chatItem) loadChat(chatItem.dataset.id);
                        if (e.target.closest('.send-reply-btn')) sendReply();
                    });

                    document.getElementById('replyInput').addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') sendReply();
                    });

                    let currentSession = null;
                    async function loadChat(id) {
                        currentSession = id;
                        document.querySelectorAll('.chat-item').forEach(e => e.classList.remove('active'));
                        document.getElementById('ci_' + id)?.classList.add('active');
                        const r = await fetch('/panel/destek/messages/' + id); const msgs = await r.json();
                        const el = document.getElementById('chatMessages');
                        el.innerHTML = msgs.map(m => `
                <div class="chat-msg ${m.sender === 'customer' ? 'customer' : 'admin'}">
                    <div class="msg-bubble">${m.message}</div>
                    <div class="msg-time">${new Date(m.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `).join('');
                        el.scrollTop = el.scrollHeight;
                    }
                    async function sendReply() {
                        if (!currentSession) return;
                        const el = document.getElementById('replyInput'); const msg = el.value.trim(); if (!msg) return;
                        await fetch('/panel/destek/reply', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: currentSession, message: msg }) });
                        el.value = ''; loadChat(currentSession);
                    }
<% if (sessions.length) {%> setInterval(() => { if (currentSession) loadChat(currentSession); }, 5000);<%}%>
                </script>

        </div>
        </body>

        </html>