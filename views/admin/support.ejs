<%- include('layout') %>

    <div class="panel-card" style="padding:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <h2 style="margin:0;">Canlı Destek (<%= sessions.length %> sohbet)</h2>
            <span class="status <%= sessions.length ? 'success' : 'pending' %>"><%= sessions.length ? 'Aktif' : 'Beklemede' %></span>
        </div>
        <div class="chat-container">
            <div class="chat-list" id="sessionList">
                <% sessions.forEach(s=> { const updated = s.updated_at ? new Date(s.updated_at).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : ''; %>
                    <div class="chat-item" data-id="<%= s.id %>" data-name="<%= s.visitor_name || 'Ziyaretçi' %>"
                        data-status="<%= s.status %>" id="ci_<%= s.id %>">
                        <div style="display:flex;justify-content:space-between;gap:8px;">
                            <strong style="font-size:14px;color:#1e293b;"><%= s.visitor_name || 'Ziyaretçi' %></strong>
                            <span class="status <%= s.status==='active'?'success':'pending' %>" style="font-size:10px;">
                                <%= s.status==='active' ?'Aktif':'Kapalı' %>
                            </span>
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin:6px 0;">
                            <%= s.last_message || 'Henüz mesaj yok' %>
                        </div>
                        <div class="chat-item-meta">
                            <span><%= updated %></span>
                            <span>•</span>
                            <span><%= s.msg_count %> mesaj</span>
                        </div>
                    </div>
                <% }); %>
                <% if (!sessions.length) { %>
                    <div style="padding:16px;color:var(--text-muted);font-size:13px;">Aktif sohbet yok.</div>
                <% } %>
            </div>
            <div class="chat-main">
                <div class="chat-header">
                    <div>
                        <h3 id="chatTitle">Sohbet seçin</h3>
                        <small id="chatMeta">Sol listeden bir konuşma seçin.</small>
                    </div>
                    <span class="status pending" id="chatStatus">Beklemede</span>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div style="color:var(--text-muted);font-size:13px;">Konuşma seçilmedi.</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="msgInput" placeholder="Mesajınızı yazın..." />
                    <button class="btn" onclick="sendMessage()">Gönder</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sessionList = document.getElementById('sessionList');
        const chatTitle = document.getElementById('chatTitle');
        const chatMeta = document.getElementById('chatMeta');
        const chatStatus = document.getElementById('chatStatus');
        const chatMessages = document.getElementById('chatMessages');
        const msgInput = document.getElementById('msgInput');
        let currentSession = null;

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>\"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '\"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        async function selectSession(id) {
            currentSession = id;
            document.querySelectorAll('.chat-item').forEach(e => e.classList.remove('active'));
            const item = document.getElementById('ci_' + id);
            if (!item) return;
            item.classList.add('active');
            chatTitle.textContent = item.dataset.name || 'Ziyaretçi';
            chatMeta.textContent = 'Sohbet #' + id;
            chatStatus.className = 'status ' + (item.dataset.status === 'active' ? 'success' : 'pending');
            chatStatus.textContent = item.dataset.status === 'active' ? 'Aktif' : 'Kapalı';
            await loadMessages(id);
        }

        async function loadMessages(id) {
            const r = await fetch('/panel/destek/messages/' + id);
            const msgs = await r.json();
            if (!msgs.length) {
                chatMessages.innerHTML = '<div style=\"color:var(--text-muted);font-size:13px;\">Henüz mesaj yok.</div>';
                return;
            }
            chatMessages.innerHTML = msgs.map(m => `
                <div class="chat-msg ${m.sender === 'customer' ? 'customer' : 'admin'}">
                    <div class="msg-bubble">${escapeHtml(m.message)}</div>
                    <div class="msg-time" style="font-size:11px;color:var(--text-muted);margin-top:4px;">
                        ${new Date(m.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>`).join('');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            if (!currentSession) return;
            const msg = msgInput.value.trim();
            if (!msg) return;
            await fetch('/panel/destek/reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: currentSession, message: msg })
            });
            msgInput.value = '';
            loadMessages(currentSession);
        }

        sessionList?.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (item) selectSession(item.dataset.id);
        });

        msgInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        <% if (sessions.length) { %>
        selectSession('<%= sessions[0].id %>');
        setInterval(() => { if (currentSession) loadMessages(currentSession); }, 5000);
        <% } %>
    </script>
