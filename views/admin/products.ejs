<%- include('layout') %>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <h2>Ürün Yönetimi (<%= products.length %> ürün)</h2>
        <button class="btn" onclick="document.getElementById('addModal').classList.add('open')">+ Yeni Ürün</button>
    </div>

    <div class="panel-table">
        <table>
            <thead>
                <tr>
                    <th>Resim</th>
                    <th>Ürün Adı</th>
                    <th>Kategori</th>
                    <th>OEM No</th>
                    <th>Fiyat</th>
                    <th>Stok</th>
                    <th>Durum</th>
                    <th>İşlem</th>
                </tr>
            </thead>
            <tbody>
                <% products.forEach(p=> { %>
                    <tr>
                        <td>
                            <% if(p.image){%><img src="/<%= p.image %>"
                                    style="width:40px;height:40px;object-fit:cover;border-radius:6px;" />
                                <%}else{%><span style="font-size:11px;color:var(--text-muted);">Görsel yok</span><%}%>
                        </td>
                        <td><strong>
                                <%= p.name %>
                            </strong>
                            <% if(p.brand){%><br><small class="muted">
                                    <%= p.brand %>
                                </small>
                                <%}%>
                        </td>
                        <td>
                            <%= p.category_name || '—' %>
                        </td>
                        <td>
                            <%= p.oem_no || '—' %>
                        </td>
                        <td class="price">
                            <%= Number(p.price).toLocaleString('tr-TR') %> ₺
                        </td>
                        <td><span class="status <%= p.stock<5?'warn':'success' %>">
                                <%= p.stock %>
                            </span></td>
                        <td><span class="status <%= p.is_active?'success':'pending' %>">
                                <%= p.is_active?'Aktif':'Pasif' %>
                            </span></td>
                        <td style="display:flex;gap:6px;">
                            <button class="btn btn-outline btn-small edit-product-btn" data-id="<%= p.id %>">Düzenle</button>
                            <button class="btn btn-outline btn-small delete-product-btn" data-id="<%= p.id %>"
                                style="color:var(--primary);">Sil</button>
                        </td>
                    </tr>
                    <% }); %>
                        <% if(!products.length){%>
                            <tr>
                                <td colspan="8" style="text-align:center;padding:32px;">Henüz ürün eklenmemiş</td>
                            </tr>
                            <%}%>
            </tbody>
        </table>
    </div>

    <!-- Add Product Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal" style="max-width:800px;">
            <button class="modal-close"
                onclick="document.getElementById('addModal').classList.remove('open')">✕</button>
            <h3>Yeni Ürün Ekle</h3>
            <form action="/panel/urunler/add" method="POST" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group"><label>Ürün Adı *</label><input type="text" name="name" required /></div>
                    <div class="form-group"><label>Marka</label><input type="text" name="brand" /></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Kategori</label><select name="category_id">
                            <option value="">Seçiniz</option>
                            <% categories.forEach(c=>{%><option value="<%= c.id %>">
                                    <%= c.name %>
                                </option>
                                <%});%>
                        </select></div>
                    <div class="form-group"><label>OEM No</label><input type="text" name="oem_no" /></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fiyat (₺) *</label><input type="number" step="0.01" name="price"
                            required /></div>
                    <div class="form-group"><label>Eski Fiyat (₺)</label><input type="number" step="0.01"
                            name="old_price" /></div>
                    <div class="form-group"><label>Stok</label><input type="number" name="stock" value="0" /></div>
                </div>
                <div class="form-group"><label>Açıklama</label><textarea name="description" rows="3"></textarea></div>
                <div class="form-group"><label>Rozet (Ör: Yeni, İndirim)</label><input type="text" name="badge" /></div>
                <div class="form-row">
                    <div class="form-group"><label>Ana Resim</label><input type="file" name="image" accept="image/*" />
                    </div>
                    <div class="form-group"><label>Resim 2</label><input type="file" name="image2" accept="image/*" />
                    </div>
                    <div class="form-group"><label>Resim 3</label><input type="file" name="image3" accept="image/*" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Araç Uyumluluğu</label>
                    <select id="addBrand">
                        <option value="">Marka seçin</option>
                        <% vehicleBrands.forEach(vb=>{%><option value="<%= vb.id %>">
                                <%= vb.name %>
                            </option>
                            <%});%>
                    </select>
                    <div id="addModels" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
                </div>
                <button class="btn btn-lg btn-block" type="submit">Ürünü Ekle</button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal" style="max-width:800px;">
            <button class="modal-close"
                onclick="document.getElementById('editModal').classList.remove('open')">✕</button>
            <h3>Ürün Düzenle</h3>
            <form id="editForm" method="POST" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group"><label>Ürün Adı *</label><input type="text" name="name" id="eName"
                            required /></div>
                    <div class="form-group"><label>Marka</label><input type="text" name="brand" id="eBrand" /></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Kategori</label><select name="category_id" id="eCategory">
                            <option value="">Seçiniz</option>
                            <% categories.forEach(c=>{%><option value="<%= c.id %>">
                                    <%= c.name %>
                                </option>
                                <%});%>
                        </select></div>
                    <div class="form-group"><label>OEM No</label><input type="text" name="oem_no" id="eOem" /></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fiyat (₺) *</label><input type="number" step="0.01" name="price"
                            id="ePrice" required /></div>
                    <div class="form-group"><label>Eski Fiyat (₺)</label><input type="number" step="0.01"
                            name="old_price" id="eOldPrice" /></div>
                    <div class="form-group"><label>Stok</label><input type="number" name="stock" id="eStock" /></div>
                </div>
                <div class="form-group"><label>Açıklama</label><textarea name="description" id="eDesc"
                        rows="3"></textarea></div>
                <div class="form-group"><label>Rozet</label><input type="text" name="badge" id="eBadge" /></div>
                <div class="form-group"><label><input type="checkbox" name="is_active" id="eActive" checked />
                        Aktif</label></div>
                <div class="form-row">
                    <div class="form-group"><label>Ana Resim (yeni yükle)</label><input type="file" name="image"
                            accept="image/*" /></div>
                    <div class="form-group"><label>Resim 2</label><input type="file" name="image2" accept="image/*" />
                    </div>
                    <div class="form-group"><label>Resim 3</label><input type="file" name="image3" accept="image/*" />
                    </div>
                </div>
                <button class="btn btn-lg btn-block" type="submit">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-product-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const r = await fetch('/api/products/' + id); const p = await r.json();
                document.getElementById('eName').value = p.name || '';
                document.getElementById('eBrand').value = p.brand || '';
                document.getElementById('eCategory').value = p.category_id || '';
                document.getElementById('eOem').value = p.oem_no || '';
                document.getElementById('ePrice').value = p.price || '';
                document.getElementById('eOldPrice').value = p.old_price || '';
                document.getElementById('eStock').value = p.stock || 0;
                document.getElementById('eDesc').value = p.description || '';
                document.getElementById('eBadge').value = p.badge || '';
                document.getElementById('eActive').checked = p.is_active == 1;
                document.getElementById('editForm').action = '/panel/urunler/edit/' + id;
                document.getElementById('editModal').classList.add('open');
            }

            const deleteBtn = e.target.closest('.delete-product-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                if (!confirm('Bu ürünü silmek istediğinize emin misiniz?')) return;
                await fetch('/panel/urunler/delete/' + id, { method: 'POST' }); location.reload();
            }
        });

        document.getElementById('addBrand').addEventListener('change', (e) => loadModelsAdmin(e.target.value, 'addModels'));

        async function loadModelsAdmin(brandId, containerId) {
            const c = document.getElementById(containerId); c.innerHTML = '';
            if (!brandId) return;
            const r = await fetch('/api/vehicle-models/' + brandId); const models = await r.json();
            models.forEach(m => {
                c.innerHTML += `<label style="display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--gray-50);border-radius:8px;font-size:12px;cursor:pointer;"><input type="checkbox" name="vehicle_models" value="${m.id}" /> ${m.name}</label>`;
            });
        }
    </script>

    </div>
    </body>

    </html>
