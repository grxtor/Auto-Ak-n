<%- include('layout') %>

    <h2 style="margin-bottom:24px;">SipariÅŸler (<%= orders.length %>)</h2>

    <div class="panel-table">
        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>MÃ¼ÅŸteri</th>
                    <th>Toplam</th>
                    <th>Durum</th>
                    <th>Ã–deme</th>
                    <th>Tarih</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody>
                <% orders.forEach(o=> { %>
                    <tr>
                        <td><strong>
                                <%= o.order_no %>
                            </strong></td>
                        <td>
                            <%= o.customer_name %><br><small class="muted">
                                    <%= o.customer_phone %>
                                </small>
                        </td>
                        <td class="price">
                            <%= Number(o.total).toLocaleString('tr-TR') %> â‚º
                        </td>
                        <td><span
                                class="status <%= o.status==='delivered'?'success':o.status==='cancelled'?'pending':'warn' %>">
                                <%= o.status %>
                            </span></td>
                        <td>
                            <span
                                class="status <%= o.payment_status==='approved'?'success':o.payment_status==='rejected'?'pending':'warn' %>">
                                <%= o.payment_status %>
                            </span>
                            <% if(o.receipt_image){%><br><a href="/<%= o.receipt_image %>" target="_blank"
                                    style="font-size:11px;color:var(--red);">ðŸ“„ Dekont</a>
                                <%}%>
                        </td>
                        <td>
                            <%= new Date(o.created_at).toLocaleDateString('tr-TR') %>
                        </td>
                        <td><button class="btn btn-outline btn-small open-order-btn" data-id="<%= o.id %>">ðŸ“‹
                                Detay</button>
                        </td>
                    </tr>
                    <% }); %>
                        <% if(!orders.length){%>
                            <tr>
                                <td colspan="7" style="text-align:center;padding:32px;">HenÃ¼z sipariÅŸ yok</td>
                            </tr>
                            <%}%>
            </tbody>
        </table>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal" style="max-width:700px;">
            <button class="modal-close">âœ•</button>
            <h3 id="omTitle">SipariÅŸ DetayÄ±</h3>
            <div id="omContent"></div>
            <hr />
            <h4>Durumu GÃ¼ncelle</h4>
            <form id="omForm">
                <input type="hidden" id="omId" />
                <div class="form-row">
                    <div class="form-group"><label>SipariÅŸ Durumu</label>
                        <select id="omStatus">
                            <option value="pending">Beklemede</option>
                            <option value="confirmed">OnaylandÄ±</option>
                            <option value="preparing">HazÄ±rlanÄ±yor</option>
                            <option value="shipped">Kargoda</option>
                            <option value="delivered">Teslim</option>
                            <option value="cancelled">Ä°ptal</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Ã–deme Durumu</label>
                        <select id="omPayment">
                            <option value="waiting">Bekleniyor</option>
                            <option value="uploaded">Dekont YÃ¼klendi</option>
                            <option value="approved">OnaylandÄ±</option>
                            <option value="rejected">Reddedildi</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Kargo Åžirketi</label><input type="text" id="omCargo" /></div>
                    <div class="form-group"><label>Takip No</label><input type="text" id="omTracking" /></div>
                </div>
                <button class="btn btn-block" type="submit">GÃ¼ncelle</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.open-order-btn')) {
                const id = e.target.closest('.open-order-btn').dataset.id;
                const r = await fetch('/panel/siparisler/' + id); const d = await r.json(); const o = d.order;
                document.getElementById('omTitle').textContent = 'SipariÅŸ: ' + o.order_no;
                document.getElementById('omId').value = id;
                document.getElementById('omStatus').value = o.status;
                document.getElementById('omPayment').value = o.payment_status;
                document.getElementById('omCargo').value = o.cargo_company || '';
                document.getElementById('omTracking').value = o.tracking_no || '';
                let html = `<div style="font-size:13px;line-height:2;"><strong>MÃ¼ÅŸteri:</strong> ${o.customer_name}<br><strong>Telefon:</strong> ${o.customer_phone}<br><strong>Email:</strong> ${o.customer_email || 'â€”'}<br><strong>Adres:</strong> ${o.customer_address || 'â€”'}<br><strong>Not:</strong> ${o.customer_note || 'â€”'}</div><hr><strong>ÃœrÃ¼nler:</strong>`;
                d.items.forEach(i => { html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--gray-100);font-size:13px;"><span>${i.product_name} Ã— ${i.quantity}</span><span style="font-weight:700;">${(i.price * i.quantity).toLocaleString('tr-TR')} â‚º</span></div>`; });
                html += `<div style="text-align:right;font-weight:800;font-size:16px;margin-top:8px;color:var(--red);">Toplam: ${Number(o.total).toLocaleString('tr-TR')} â‚º</div>`;
                document.getElementById('omContent').innerHTML = html;
                document.getElementById('orderModal').classList.add('open');
            }

            if (e.target.closest('.modal-close')) {
                e.target.closest('.modal-overlay').classList.remove('open');
            }
        });

        document.getElementById('omForm').addEventListener('submit', async (e) => {
            e.preventDefault(); const id = document.getElementById('omId').value;
            const r = await fetch('/panel/siparisler/update/' + id, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                    status: document.getElementById('omStatus').value, payment_status: document.getElementById('omPayment').value,
                    tracking_no: document.getElementById('omTracking').value, cargo_company: document.getElementById('omCargo').value
                })
            });
            const d = await r.json(); if (d.success) { showToast('SipariÅŸ gÃ¼ncellendi!'); setTimeout(() => location.reload(), 800); }
        });
    </script>

    </div>
    </body>

    </html>