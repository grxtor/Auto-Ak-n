<%- include('partials/header') %>

    <script type="application/ld+json">
{"@context":"https://schema.org","@type":"Product","name":"<%= product.name %>","description":"<%= (product.description||'').substring(0,200) %>","brand":{"@type":"Brand","name":"<%= product.brand || 'Auto Akın' %>"},"offers":{"@type":"Offer","price":"<%= product.price %>","priceCurrency":"TRY","availability":"<%= product.stock > 0 ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock' %>"}}
</script>

    <div class="page-header">
        <div class="breadcrumb">
            <a href="/">Ana Sayfa</a> <span>→</span>
            <a href="/urunler">Ürünler</a> <span>→</span>
            <% if (product.category_name) { %><a href="/urunler?category_id=<%= product.category_id %>">
                    <%= product.category_name %>
                </a> <span>→</span>
                <% } %>
                    <span>
                        <%= product.name %>
                    </span>
        </div>
    </div>

    <div class="product-detail">
        <div class="detail-img">
            <% if (product.image) { %>
                <img src="/<%= product.image %>" alt="<%= product.name %>" id="mainImg"
                    style="width:100%;max-height:400px;object-fit:contain;border-radius:var(--radius);" />
                <% } else { %>
                    <div
                        style="background:var(--gray-100);height:300px;display:grid;place-items:center;border-radius:var(--radius);font-weight:700;color:var(--gray-500);">
                        Görsel bulunmuyor</div>
                    <% } %>
                        <% if (product.image2 || product.image3) { %>
                            <div style="display:flex;gap:8px;margin-top:8px;">
                                <% [product.image, product.image2, product.image3].filter(Boolean).forEach((img, i)=> {
                                    %>
                                    <img src="/<%= img %>" class="thumb-img"
                                        style="height:60px;width:60px;object-fit:cover;border-radius:8px;border:2px solid <%= i===0 ? 'var(--red)' : 'transparent' %>;cursor:pointer;" />
                                    <% }); %>
                            </div>
                            <% } %>
        </div>

        <div class="detail-info">
            <% if (product.brand) { %>
                <div class="detail-brand">
                    <%= product.brand %>
                </div>
                <% } %>
                    <h1>
                        <%= product.name %>
                    </h1>
                    <% if (product.oem_no) { %>
                        <div style="margin:6px 0;font-size:13px;color:var(--gray-500);">OEM No: <strong>
                                <%= product.oem_no %>
                            </strong></div>
                        <% } %>

                            <div class="detail-price">
                                <span style="font-family:'Anton',sans-serif;font-size:32px;color:var(--red);">
                                    <%= Number(product.price).toLocaleString('tr-TR') %> TL
                                </span>
                                <% if (product.old_price) { %>
                                    <span
                                        style="text-decoration:line-through;color:var(--gray-500);font-size:18px;margin-left:8px;">
                                        <%= Number(product.old_price).toLocaleString('tr-TR') %> TL
                                    </span>
                                    <span class="product-badge" style="margin-left:8px;">%<%= Math.round((1 -
                                            product.price / product.old_price) * 100) %> İndirim</span>
                                    <% } %>
                            </div>

                            <div style="margin:12px 0;">
                                <% if (product.stock> 0) { %>
                                    <span
                                        style="background:var(--green-bg);color:var(--green);padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;">✓
                                        Stokta (<%= product.stock %> adet)</span>
                                    <% } else { %>
                                        <span
                                            style="background:var(--red-light);color:var(--red);padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;">✗
                                            Stokta Yok</span>
                                        <% } %>
                            </div>

                            <% if (product.description) { %>
                                <p class="muted" style="margin:16px 0;line-height:1.8;"><%-
                                        product.description.replace(/\n/g, '<br>' ) %></p>
                                <% } %>

                                    <% if (vehicles.length) { %>
                                        <div
                                            style="margin:16px 0;padding:16px;background:var(--gray-50);border-radius:12px;">
                                            <strong style="font-size:13px;">Uyumlu Araçlar</strong>
                                            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">
                                                <% vehicles.forEach(v=> { %>
                                                    <span
                                                        style="background:var(--white);padding:4px 12px;border-radius:999px;font-size:12px;border:1px solid var(--gray-200);">
                                                        <%= v.brand_name %>
                                                            <%= v.name %>
                                                                <%= v.year_start ? `(${v.year_start}-${v.year_end
                                                                    || '...' })` : '' %>
                                                    </span>
                                                    <% }); %>
                                            </div>
                                        </div>
                                        <% } %>

                                            <% if (product.stock> 0) { %>
                                                <div style="margin:20px 0;display:flex;align-items:center;gap:12px;">
                                                    <button class="btn btn-outline qty-btn" data-d="-1">−</button>
                                                    <input type="number" id="qty" value="1" min="1"
                                                        max="<%= product.stock %>"
                                                        style="width:60px;text-align:center;padding:10px;border:1px solid var(--gray-200);border-radius:10px;font-weight:700;" />
                                                    <button class="btn btn-outline qty-btn" data-d="1">+</button>
                                                </div>
                                                <button class="btn btn-lg add-to-cart-btn"
                                                    data-id="<%= product.id %>">
                                                    Sepete Ekle</button>
                                                <% } %>

                                                    <button class="btn btn-outline fav-btn" id="favBtn"
                                                        data-id="<%= product.id %>"
                                                        data-logged="<%= user ? '1' : '0' %>" style="margin-left:8px;">
                                                        <%= isFav ? 'Favorilerde' : 'Favorilere Ekle' %>
                                                    </button>
        </div>
    </div>

    <% if (related.length) { %>
        <section class="section light">
            <div class="section-header">
                <h2>Benzer Ürünler</h2>
            </div>
            <div class="grid grid-4">
                <% related.forEach(r=> { %>
                    <a class="product-card" href="/urun/<%= r.id %>">
                        <div class="product-img">
                            <% if (r.image) { %><img src="/<%= r.image %>" alt="<%= r.name %>" />
                                <% } %>
                        </div>
                        <div class="product-brand">
                            <%= r.brand || '' %>
                        </div>
                        <div class="product-title">
                            <%= r.name %>
                        </div>
                        <div class="product-prices"><span class="product-price">
                                <%= Number(r.price).toLocaleString('tr-TR') %> TL
                            </span></div>
                    </a>
                    <% }); %>
            </div>
        </section>
        <% } %>

            <script>
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.thumb-img')) {
                        document.getElementById('mainImg').src = e.target.closest('.thumb-img').src;
                    }

                    if (e.target.closest('.qty-btn')) {
                        const d = parseInt(e.target.closest('.qty-btn').dataset.d);
                        const stock = <%= product.stock %>;
                        const el = document.getElementById('qty');
                        let v = parseInt(el.value) + d;
                        if (v < 1) v = 1;
                        if (v > stock) v = stock;
                        el.value = v;
                    }

                    if (e.target.closest('.add-to-cart-btn')) {
                        const id = e.target.closest('.add-to-cart-btn').dataset.id;
                        const qty = parseInt(document.getElementById('qty').value);
                        addToCart(id, qty);
                    }

                    if (e.target.closest('.fav-btn')) {
                        const btn = e.target.closest('.fav-btn');
                        if (btn.dataset.logged === '0') {
                            window.location.href = '/giris';
                            return;
                        }
                        const id = btn.dataset.id;
                        fetch('/api/favorites/toggle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: id })
                        })
                            .then(r => r.json()).then(d => {
                                btn.innerHTML = d.status === 'added' ? 'Favorilerde' : 'Favorilere Ekle';
                                showToast(d.status === 'added' ? 'Favorilere eklendi!' : 'Favorilerden çıkarıldı');
                            });
                    }
                });
            </script>

            <%- include('partials/footer') %>
