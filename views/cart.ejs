<%- include('partials/header') %>
    <div class="page-header">
        <div class="breadcrumb"><a href="/">Ana Sayfa</a> <span>→</span> <span>Sepet</span></div>
        <h1>Alışveriş Sepeti</h1>
    </div>

    <div id="cartContent" style="display:none;display:grid;grid-template-columns:1fr 320px;gap:24px;">
        <div class="panel-table">
            <table>
                <thead>
                    <tr>
                        <th>Ürün</th>
                        <th>Fiyat</th>
                        <th>Adet</th>
                        <th>Toplam</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cartBody"></tbody>
            </table>
        </div>
        <div>
            <div class="panel-card">
                <div class="card-header">Sipariş Özeti</div>
                <div style="display:flex;justify-content:space-between;margin:12px 0;font-size:14px;"><span>Toplam
                        Ürün</span><span id="totalItems">0</span></div>
                <div style="display:flex;justify-content:space-between;margin:12px 0;font-size:14px;">
                    <span>Kargo</span><span style="color:var(--green);font-weight:700;">Ücretsiz</span></div>
                <hr style="border:none;border-top:1px solid var(--gray-200);margin:12px 0;" />
                <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:800;">
                    <span>Toplam</span><span id="totalPrice" style="color:var(--red);">0 TL</span></div>
                <a class="btn btn-lg btn-block" href="/odeme" style="margin-top:16px;">Siparişi Tamamla →</a>
            </div>
        </div>
    </div>
    <div class="empty-state" id="emptyCart" style="display:none;">
        <div class="empty-state-icon">Sepet boş</div>
        <h3>Sepetiniz boş</h3>
        <p class="muted">Henüz ürün eklemediniz.</p><a class="btn" href="/urunler">Alışverişe Başla</a>
    </div>

    <script>
        async function renderCart() {
            const items = getCart();
            const content = document.getElementById('cartContent');
            const empty = document.getElementById('emptyCart');
            if (!items.length) { content.style.display = 'none'; empty.style.display = 'block'; return; }
            content.style.display = 'grid'; empty.style.display = 'none';
            const body = document.getElementById('cartBody'); body.innerHTML = '';
            let ti = 0, tp = 0;
            for (const item of items) {
                const r = await fetch('/api/products/' + item.id); const p = await r.json(); if (p.error) continue;
                const lt = p.price * item.qty; ti += item.qty; tp += lt;
                body.innerHTML += `<tr>
      <td style="display:flex;align-items:center;gap:12px;">${p.image ? `<img src="/${p.image}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;" />` : ''}<div><div style="font-weight:700;">${p.name}</div><div style="font-size:11px;color:var(--gray-500);">${p.brand || ''}</div></div></td>
      <td>${Number(p.price).toLocaleString('tr-TR')} TL</td>
      <td><div style="display:flex;align-items:center;gap:6px;"><button class="btn btn-outline btn-small" onclick="updCart(${p.id},-1)">−</button><span style="font-weight:700;min-width:20px;text-align:center;">${item.qty}</span><button class="btn btn-outline btn-small" onclick="updCart(${p.id},1)">+</button></div></td>
      <td style="font-weight:700;">${lt.toLocaleString('tr-TR')} TL</td>
      <td><button class="btn btn-outline btn-small" onclick="rmCart(${p.id})" style="color:var(--red);">✕</button></td>
    </tr>`;
            }
            document.getElementById('totalItems').textContent = ti + ' adet';
            document.getElementById('totalPrice').textContent = tp.toLocaleString('tr-TR') + ' TL';
        }
        function updCart(id, d) { const i = getCart(); const x = i.findIndex(a => a.id == id); if (x === -1) return; i[x].qty += d; if (i[x].qty < 1) i.splice(x, 1); saveCart(i); renderCart(); }
        function rmCart(id) { saveCart(getCart().filter(i => i.id != id)); renderCart(); }
        document.addEventListener('DOMContentLoaded', renderCart);
    </script>
    <%- include('partials/footer') %>
